function tos_api(){var e=this;e.init=async function(){return await e.cache.init(),!0},e.event={get:async function(){var t;if(e.settings.cache.allow){console.log("已啟用快取功能，查詢快取資料");let n=await e.cache.get("event",null);n&&(t=n)}if(!t){console.log("開始向伺服器請求活動資料");var n=await fetch(`${e.settings.server}/v1/event/get`).then(e=>e.json());n.info.success&&(console.log("成功向伺服器請求活動資料",n),e.settings.cache.allow&&(console.log("已啟用快取功能，寫入快取資料"),e.cache.set("event",n.data)),t=n.data)}return console.log("回傳活動資料"),t}},e.card={get:async function(t){if("string"==typeof t)t=[t];else if("number"==typeof t)t=[t.toString()];else{if(!(Array.isArray(t)&&t.length>0))return!1;t=t.map(e=>"string"==typeof e?e:"number"==typeof e?e.toString():"")}var n=[],c={};if(e.settings.cache.allow){console.log("已啟用快取功能，查詢快取資料");let a=await e.cache.get("card",t);n=a.request,a.local.forEach(e=>{c[e[0]]=e[1]})}else n=t;if(n.length>0){console.log("開始向伺服器請求卡片資料",n);var a=await fetch(`${e.settings.server}/v1/card/info?id=${n.join(",")}`).then(e=>e.json());a.info.success&&(console.log("成功向伺服器請求卡片資料",a),e.settings.cache.allow&&(console.log("已啟用快取功能，寫入快取資料"),e.cache.set("card",a.data)),Object.entries(a.data).forEach(e=>{c[e[0]]=e[1]}))}return console.log("回傳卡片資料"),c},search:async function(t={}){Object.entries(t).forEach(e=>{Array.isArray(e[1])&&(t[e[0]]=e[1].join(","))});let n=new URLSearchParams(t);try{var c=await fetch(`${e.settings.server}/v1/card/search?${n.toString()}`).then(e=>e.json());if(c.info.success)return console.log("成功向伺服器搜尋卡片資料",c),c.data;throw new Error("向 API 搜尋卡片資料時發生未知錯誤")}catch(e){return Promise.reject(new Error("發生錯誤："+e))}},all:async function(){return e.card.search({star:[1,2,3,4,5,6,7,8]})}},e.stage={get:async function(t){var n;if(e.settings.cache.allow){console.log("已啟用快取功能，查詢快取資料");let c=await e.cache.get("stage",t);c&&(n=c)}if(!n){console.log("開始向 API 請求關卡資料");var c=await fetch(`${e.settings.server}/v1/stage/info?name=${t}`).then(e=>e.json());c.info.success&&(console.log("成功向 API 請求關卡資料",c),e.settings.cache.allow&&(console.log("已啟用快取功能，寫入快取資料"),e.cache.set("stage",c)),n=c.data)}return console.log("回傳關卡資料"),n}},e.cache={init:async function(){if(!window.indexedDB)return e.settings.cache.allow=!1,console.log("瀏覽器不支援 indexedDB，已關閉快取功能"),!1;e.cache.db||(e.cache.db={});let t=[];e.cache.db.card||(e.cache.db.card=indexedDB.open("Card Cache",1));let n=new Promise((t,n)=>{e.cache.db.card.onsuccess=function(){e.cache.db.card=e.cache.db.card.result,console.log("卡片快取已建立"),t(!0)}});t.push(n),e.cache.db.card.onupgradeneeded=function(e){var t=e.currentTarget.result.createObjectStore("cards",{keyPath:"id"});t.createIndex("card","card",{unique:!1}),t.createIndex("expire","expire",{unique:!1}),console.log("卡片快取升級完成")},e.cache.db.event||(e.cache.db.event=indexedDB.open("Event Cache",1));let c=new Promise((t,n)=>{e.cache.db.event.onsuccess=function(){e.cache.db.event=e.cache.db.event.result,console.log("活動快取已建立"),t(!0)}});t.push(c),e.cache.db.event.onupgradeneeded=function(e){var t=e.currentTarget.result.createObjectStore("event",{keyPath:"key"});t.createIndex("event","event",{unique:!1}),t.createIndex("expire","expire",{unique:!1}),console.log("活動快取升級完成")},e.cache.db.stage||(e.cache.db.stage=indexedDB.open("Stage Cache",1));let a=new Promise((t,n)=>{e.cache.db.stage.onsuccess=function(){e.cache.db.stage=e.cache.db.stage.result,console.log("關卡快取已建立"),t(!0)}});return t.push(a),e.cache.db.stage.onupgradeneeded=function(e){var t=e.currentTarget.result.createObjectStore("stages",{keyPath:"name"});t.createIndex("stage","stage",{unique:!1}),t.createIndex("expire","expire",{unique:!1}),console.log("關卡快取升級完成")},await Promise.all(t),!0},get:async function(t,n){if("event"==t){var c=e.cache.db.event.transaction("event","readwrite").objectStore("event");let t=await new Promise((e,t)=>{let n=c.get("events");n.onsuccess=function(){e(n.result)}});return t&&null!=t.event?t.expire>=Date.now()?(console.log("已取得符合的活動快取資料，使用快取資料"),t.event):(c.delete("events"),console.log("符合的活動快取資料已過期，準備請求"),!1):(console.log("未取得符合的活動快取資料，準備請求"),!1)}if("card"==t){c=e.cache.db.card.transaction("cards","readwrite").objectStore("cards");var a=[],o=[];for(let e=0;e<n.length;e++){let t=await new Promise((t,a)=>{let o=c.get(n[e]);o.onsuccess=function(){t(o.result)}});t&&null!=t.card?t.expire>=Date.now()?(console.log(`已取得符合 No.${n[e]} 的卡片快取資料，使用快取資料`),o.push([n[e],t.card])):(c.delete(n[e]),console.log(`符合 No.${n[e]} 的卡片快取資料已過期，加入請求儲列`),a.push(n[e])):(console.log(`未取得符合 No.${n[e]} 的卡片快取資料，加入請求儲列`),a.push(n[e]))}return{request:a,local:o}}if("stage"==t){c=e.cache.db.stage.transaction("stages","readwrite").objectStore("stages");let t=await new Promise((e,t)=>{let a=c.get(n);a.onsuccess=function(){e(a.result)}});return t&&null!=t.stage?t.expire>=Date.now()?(console.log("已取得符合的關卡快取資料，使用快取資料"),t.stage):(c.delete("events"),console.log("符合的關卡快取資料已過期，準備請求"),!1):(console.log("未取得符合的關卡快取資料，準備請求"),!1)}},set:async function(t,n){"event"==t&&new Promise((t,c)=>{var a={key:"events",expire:Date.now()+e.settings.cache.expire.event,event:n};e.cache.db.event.transaction("event","readwrite").objectStore("event").put(a).onsuccess=function(){t(a)}}).then(e=>{e?console.log("已寫入快取資料",e):console.error("寫入快取資料失敗")}).catch(e=>{console.error("寫入快取資料失敗",e)}),"card"==t&&Object.entries(n).forEach(t=>{new Promise((n,c)=>{var a={id:t[0],expire:Date.now()+e.settings.cache.expire.card,card:t[1]};e.cache.db.card.transaction("cards","readwrite").objectStore("cards").put(a).onsuccess=function(){n(a)}}).then(e=>{e?console.log("已寫入快取資料",e):console.error("寫入快取資料失敗")}).catch(e=>{console.error("寫入快取資料失敗",e)})}),"stage"==t&&new Promise((t,c)=>{var a={name:n.info.request.params.name,expire:Date.now()+e.settings.cache.expire.event,stage:n.data};e.cache.db.stage.transaction("stages","readwrite").objectStore("stages").put(a).onsuccess=function(){t(a)}}).then(e=>{e?console.log("已寫入快取資料",e):console.error("寫入快取資料失敗")}).catch(e=>{console.error("寫入快取資料失敗",e)})},info:async function(){var t=function(e,t){return new Promise((n,c)=>{var a=0,o=e.transaction([t]).objectStore(t).openCursor();o.onsuccess=function(e){var t=e.target.result;if(t){var c=t.value,o=JSON.stringify(c);a+=o.length,t.continue()}else n(a)}.bind(this),o.onerror=function(e){c("error: "+e)}})};let n=["card","event","stage"],c={},a=0;for(let r=0;r<n.length;r++){let s=n[r],i=e.cache.db[s];var o=[...i.objectStoreNames].reduce((e,n)=>(e.push(t(i,n)),e),[]);let l=0;await Promise.all(o).then(e=>{l+=Number(e)}),c[s]=l,a+=l}return c.TOTAL=a,c.READABLE=function(e){if(Math.abs(e)<1024)return e+" B";var t=["KB","MB","GB"],n=-1;do{e/=1024,++n}while(Math.abs(e)>=1024&&n<t.length-1);return e.toFixed(1)+" "+t[n]}(a),c},clear:function(){indexedDB.deleteDatabase("Card Cache"),indexedDB.deleteDatabase("Event Cache"),indexedDB.deleteDatabase("Stage Cache"),console.log("已清除快取資料")}},e.settings={server:"https://tos-api.pascaltheelf.tk",cache:{allow:!0,expire:{event:6e4,card:36e5,stage:3e5}}}}
